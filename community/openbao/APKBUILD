# Maintainer: Kevin Daudt <kdaudt@alpinelinux.org>
pkgname=openbao
pkgver=2.3.1
_pkgver=${pkgver/_/-}
pkgrel=2
pkgdesc="solution to manage, store, and distribute sensitive data including secrets, certificates, and keys"
url="https://openbao.org/"
arch="all"
license="MPL-2.0"
makedepends="go bash"
install="$pkgname.pre-install"
pkgusers="openbao"
pkggroups="openbao"
subpackages="$pkgname-openrc"
options="!check net" # many tests require docker
source="https://github.com/openbao/openbao/archive/v$_pkgver/openbao-$_pkgver.tar.gz
	make-bin-without-ui.patch
	build-do-not-assume-git-repo.patch
	build-do-not-install.patch
	openbao.confd
	openbao.hcl
	openbao.initd
	"

# secfixes:
#   2.3.1-r0:
#     - CVE-2025-52894
#     - CVE-2025-52893
#   2.2.2-r0:
#     - CVE-2025-4166

prepare() {
	default_prepare

	echo "$_pkgver" >version/VERSION
}

build() {
	OPENBAO_VERSION=$pkgver CGO_ENABLED=1 make bin
}

check() {
	make test
}

package() {
	install -Dm0755 -t "$pkgdir/usr/bin/" bin/bao

	install -m755 -D "$srcdir/$pkgname.initd" \
		"$pkgdir/etc/init.d/$pkgname"

	install -m644 -D "$srcdir/$pkgname.confd" \
		"$pkgdir/etc/conf.d/$pkgname"

	install -m640 -o root -g openbao -D "$srcdir/$pkgname.hcl" \
		"$pkgdir/etc/$pkgname.hcl"

	install -m750 -o openbao -g openbao -d "$pkgdir/var/lib/$pkgname"
}

sha512sums="
7bc1e141c416b80624b0ffe368436ec53c907bc8aa6b26f99717b78458322355283e7862393e9ec1d58854cc8d15144c46df72b11aa90f64d554c6c7283aeb79  openbao-2.3.1.tar.gz
367c1f063d66dfa1937d7363975bbb6b2f2fafc2f38ce4ba1a1ee0e153443dc99b4e9ad2a944083a186d34bbe494d2c522c92f44ba09ad63dc56b66e42686b02  make-bin-without-ui.patch
7805e6bf9d88cd2321832151ec1e985ecf5a1350176fd18ef1032398ffbf8ff2f0a73b9ba44e41b15e3e8bdc825679463c8ef04ae04f9096f459fcda6f44a11c  build-do-not-assume-git-repo.patch
4277f815de3b9d2e54489a10fec06416d8f2802c0cc702d4a81dae3ab41b23bd8387981536925765450077bffdb05a43f10e4516a89e28c9a2899d480a9fe8f9  build-do-not-install.patch
f6ab6bf696085c350f08952084b865aa9bbf191a627f73cbf811632ed9282a31188e7386380dd89ffce38e4e8c4686b39fe15d46a2ff468c1347a773b64dc7ff  openbao.confd
6b833c86d18d0f1033f6a0a45c03c5a2191075fbe2c0fa6dede2e510c7aada2fa595cadc2a544a654347f9c9d264de1ddd1f8c3b3b06c881834a41379717fa0e  openbao.hcl
8d835dee70418eaec091f30efd2c3254537b584802d3bd4a5c4d2367b5e1ca1f7b4cc99015ba6346e597ca9b07eddc75f067f9688eed44ee439ef2cdc67def57  openbao.initd
"
